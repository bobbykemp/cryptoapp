{% extends "app/base.html" %} {% block content %} {%load rest_framework%}

<div class="container">
  <div class="row">
    <div class="col">
      <table class="table table-dark">
        <thead>
          <tr>
            <th scope="col">Username</th>
            <th scope="col">This User's Messaging Public Key</th>
            <th scope="col">This User's Signing Key</th>
          </tr>
        </thead>
        <tbody id="key-table-body"></tbody>
      </table>
    </div>
  </div>

  <!-- Encrypt Modal -->
  <div
    class="modal fade"
    id="inputModal"
    tabindex="-1"
    role="dialog"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLongTitle">
            Encrypt a Message for This User
          </h5>
          <button
            type="button"
            class="close"
            data-dismiss="modal"
            aria-label="Close"
          >
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <form
          action="/api/message/encrypt/"
          method="post"
          onsubmit="setKeyID();"
        >
          <div class="modal-body">
            {%csrf_token%}
            <div class="form-group">
              <label for="content">Message</label>
              <textarea
                class="form-control"
                id="content"
                name="content"
                rows="4"
              ></textarea>
            </div>
            <div class="form-group">
              <label for="signed">Sign Message</label>
              <input type="checkbox" id="signed" name="signed" />
            </div>
            <input
              type="hidden"
              id="recip-key-id"
              name="recipient_public_key"
            />
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
            <button type="submit" class="btn btn-primary">Save changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Decrypt Modal -->
  <div
    class="modal fade"
    id="decryptModal"
    tabindex="-1"
    role="dialog"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="decryptModalTitle">
            Decrypt a Message from This User
          </h5>
          <button
            type="button"
            class="close"
            data-dismiss="modal"
            aria-label="Close"
          >
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <form
          action="/api/message/decrypt/"
          method="post"
          onsubmit="setKeyIDdecrypt();"
          enctype="multipart/form-data"
        >
          <div class="modal-body">
            {%csrf_token%}
            <div class="form-group">
              <label for="content">File to Decrypt</label>
              <input type="file" name="file_to_decrypt">
            </div>
            <div class="form-group">
              <label for="signed">Is Message Signed?</label>
              <input type="checkbox" id="signed" name="signed" />
            </div>
            <input
              type="hidden"
              id="sign-key-id"
              name="signing_key"
            />
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
            <button type="submit" class="btn btn-primary">Save changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  var messaging_key_id,
    sign_key_id = null;

  var setKeyID = function () {
    $("#recip-key-id").val(messaging_key_id);
    return true;
  };

  var setKeyIDdecrypt = function () {
    $("#sign-key-id").val(sign_key_id);
    return true;
  };

  var setLine = function (m, s) {
    messaging_key_id = m;
    sign_key_id = s;
  };

  var getKeys = function () {
    $("#key-table-body").empty();
    $.ajax({
      url: "/api/user-keys/",
      dataType: "json",
      success: function (data) {
        console.log(data);
        $.each(data, function (index) {
          var username = data[index]["user"]["username"];
          var msg_key_id = data[index]["messaging_key"];
          var sign_id = data[index]["signing_key"];
          if (username != "{{request.user.username}}") {
            $("#key-table-body").append(`
              <tr>
                <td>${username}</td>
                <td>
                  <a class="btn btn-light" href="/api/keys/${msg_key_id}/get_public_key_as_file/">Download</a>
                </td>
                <td>
                  <a class="btn btn-light" href="/api/keys/${sign_id}/get_public_key_as_file/">Download</a>
                </td>
                <td>
                  <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#inputModal" onClick="setLine('${msg_key_id}', '${sign_id}')">Encrypt a Message for This User</button>
                </td>
                <td>
                  <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#decryptModal" onClick="setLine('${msg_key_id}', '${sign_id}')">Decrypt a Message from This User</button>
                </td>
              </tr>
            `);
          }
        });
      },
    });
  };

  $(document).ready(function () {
    getKeys();
  });
</script>

{%endblock%}
