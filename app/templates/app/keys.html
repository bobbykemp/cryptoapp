{% extends "app/base.html" %}
{% block content %}
{%load rest_framework%}

<div class="container">
  <div class="row pb-3">
    <div class="col">
      <a class="btn btn-dark" href="#" onclick="makeKey()">+ Create New KeyPair +</a>
    </div>
  </div>

  <div class="row">
    <div class="col">
        <table class="table table-dark">
          <thead>
          <tr>
            <th scope="col">ID</th>
            <th scope="col">Private Key</th>
            <th scope="col">Public Key</th>
          </tr>
          </thead>
          <tbody id="key-table-body">
          </tbody>
        </table>
      </div>
  </div>
</div>

<script>

  var getKeys = function(){
    $('#key-table-body').empty();
    $.ajax({
      url: '/api/keys/',
      dataType: 'json',
      success: function(data){
        $.each(data, function(index){
          var id = data[index]['secure_id'];
          var pk = data[index]['id'];
          var key = data[index]['key_from_bytes'];
          $('#key-table-body').append(`
            <tr>
              <td>${id}</td>
              <td>
                <a  class="btn btn-light"
                    href="/api/keys/${id}/get_private_key_as_file/"
                    onclick="alert('Never share your private key with anyone.')">
                    Download Private Key
                </a>
              </td>
              <td>
                <a class="btn btn-light" href="/api/keys/${id}/get_public_key_as_file/">Download Public Key</a>
              </td>
              <td>
                <div class="btn-group" data-toggle="buttons" onclick="setKey('signing', '${id}');">
                  <label class="btn btn-light">
                    <input type="radio" name="signing" pk="${id}" id="signing-${id}"/> Set This as Signing Key
                  </label>
                </div>
              </td>
              <td>
                <div class="btn-group" data-toggle="buttons" onclick="setKey('messaging', '${id}');">
                  <label class="btn btn-light">
                    <input type="radio" name="messaging" pk="${id}" id="encryption-${id}"/> Set This as Encryption Key
                  </label>
                </div>
              </td>
              <td>
                <a class="btn btn-danger" href="#" onclick="destroyKey('${id}')">Delete This KeyPair</a>
              </td>
            </tr>
          `);
        });
      }
    });
    setChecks();
  };

  var setChecks = function(){
    $.ajax({
      url: '/api/user-keys/{{request.user.id}}/',
      beforeSend(xhr, settings) {
        xhr.setRequestHeader("X-CSRFToken", '{{csrf_token}}');
      },
    }).done(function(data){
        var s_pk = data['signing_key'];
        var m_pk = data['messaging_key'];
        $('#key-table-body').find('td div label input').each(function(index, element){
          if($(element).attr('pk') == s_pk && $(element).attr('name') == 'signing'){
            $(element).attr('checked', 'checked');
          }
          if($(element).attr('pk') == m_pk && $(element).attr('name') == 'messaging'){
            $(element).attr('checked', 'checked');
          }
        });
    });
  }

  var makeKey = function(){
    $.ajax({
      url: '/api/keys/',
      method: 'POST',
      beforeSend(xhr, settings) {
        xhr.setRequestHeader("X-CSRFToken", '{{csrf_token}}');
      },
      success: function(){
        getKeys();
      }
    })
  };

  var destroyKey = function(key_id){
    if (confirm("Are you sure?")){
      $.ajax({
        url: '/api/keys/' + key_id + '/',
        method: 'DELETE',
        beforeSend(xhr, settings) {
          xhr.setRequestHeader("X-CSRFToken", '{{csrf_token}}');
        },
        success: function(){
          getKeys();
        }
      });
    }
  };

  var setKey = function(type, key_id){
    var name = type+'_key';
    var data = {};
    data[name] = key_id;
    json_data = JSON.stringify(data);
    $.ajax({
      url: '/api/user-keys/{{request.user.id}}/',
      method: 'PUT',
      dataType: 'json',
      contentType: 'application/json',
      data: json_data,
      beforeSend(xhr, settings) {
        xhr.setRequestHeader("X-CSRFToken", '{{csrf_token}}');
      },
      success: function(){
        getKeys();
      }
    });
  };

  $(document).ready(function() {

    getKeys();
    setChecks();

    $("#key-table-body").on('click', ':button', function(){
      var id = $(this).attr('id');
      var type = $(this).attr('keytype');
      $.ajax({
        url: '/api/keys/' + id + '/get_' + type + '_key_as_file/',
        method: 'POST',
        dataType: 'octet-stream',
        beforeSend(xhr, settings) {
          xhr.setRequestHeader("X-CSRFToken", '{{csrf_token}}');
        },
        success: function(data){
          console.log(data);
        }
      })
    });
  });

</script>

{%endblock%}